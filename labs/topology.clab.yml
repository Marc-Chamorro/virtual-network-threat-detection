# 0.0.2

# https://containerlab.dev/lab-examples/frr01/
# https://containerlab.dev/manual/config-mgmt/

# KALI - connect with bash, not cli

name: virtual-env

topology:
  nodes:

    ###############################################################################################
    # Internet
    ###############################################################################################
    
    router_internet:
      kind: linux
      image: frr_vntd:latest
      binds:
        - ./config/router/daemons:/etc/frr/daemons
        - ./config/router/internet/frr.conf:/etc/frr/frr.conf
      exec:
        - sysctl -w net.ipv4.ip_forward=1

    internet_server:
      kind: linux
      image: alpine_vntd:latest
      exec:
        - ip addr add 172.16.100.100/24 dev eth1
        - ip link set eth1 up
        - ip route del default
        - ip route add default via 172.16.100.1

    ###############################################################################################
    # Attacker network
    ###############################################################################################
    
    router_attacker:
      kind: linux
      image: frr_vntd:latest
      binds:
        - ./config/router/daemons:/etc/frr/daemons
        - ./config/router/attacker/frr.conf:/etc/frr/frr.conf
    
    attacker:
      kind: linux
      image: kali_vntd:latest
      exec:
        - ip addr add 10.0.0.2/24 dev eth1
        - ip link set eth1 up
        - ip route del default # Remove all existing connections, including the internet
        - ip route add default via 10.0.0.1
    
    ###############################################################################################
    # Benign network
    ###############################################################################################
    
    router_benign:
      kind: linux
      image: frr_vntd:latest
      binds:
        - ./config/router/daemons:/etc/frr/daemons
        - ./config/router/benign/frr.conf:/etc/frr/frr.conf
      exec:
        - sysctl -w net.ipv4.ip_forward=1

    benign:
      kind: linux
      image: alpine_vntd:latest
      exec:
        - ip addr add 20.0.0.2/24 dev eth1
        - ip link set eth1 up
        - ip route del default # Remove all existing connections, including the internet
        - ip route add default via 20.0.0.1

    ###############################################################################################
    # Enterprise network
    ###############################################################################################
    
    router_enterprise:
      kind: linux
      image: router_vntd:latest
      binds:
        - ./config/router/enterprise/frr.conf:/etc/frr/frr.conf
      exec:
        # Enable forwarding
        - sysctl -w net.ipv4.ip_forward=1

        # Interface IPs
        - ip addr add 172.16.30.2/30 dev eth1
        - ip addr add 192.168.0.1/30 dev eth2
        - ip link set eth1 up
        - ip link set eth2 up

        - ip route add 192.168.10.0/24 via 192.168.0.2
        - ip route add 192.168.20.0/24 via 192.168.0.2
        - ip route add 192.168.30.0/24 via 192.168.0.2
        - ip route add default via 172.16.30.1

        # NAT
        #- iptables -t nat -A POSTROUTING -s 192.168.0.0/16 -o eth1 -j MASQUERADE
        - iptables -t nat -A POSTROUTING -o eth1 -j MASQUERADE

        # Default route
        - ip route add default via 172.16.30.1

        # Start FRR
        - /usr/lib/frr/frrinit.sh start
      
    # https://containerlab.dev/manual/nodes/#cpu-set
    # multilayer_switch:
      # kind: juniper_vjunosswitch
      # image: vrnetlab/juniper_vjunos-switch:23.2R1.14
      # startup-config: ./config/mls/enterprise/mls.cfg
      # cpu: 2
      # memory: 4GB

    multilayer_switch:
      kind: arista_ceos
      image: ceos_vntd:latest
      startup-config: ./config/mls/enterprise/mls_arista.cli

    # Arista BASH + Cli command to access

    switch_vlan10:
      kind: arista_ceos
      image: ceos_vntd:latest
      startup-config: ./config/switch/enterprise/config_v10.cli

    switch_vlan20:
      kind: arista_ceos
      image: ceos_vntd:latest
      startup-config: ./config/switch/enterprise/config_v20.cli

    switch_vlan30:
      kind: arista_ceos
      image: ceos_vntd:latest
      startup-config: ./config/switch/enterprise/config_v30.cli

    #switch_vlan10:
    #  kind: nokia_srlinux
    #  image: ghcr.io/nokia/srlinux:25.10
    #  startup-config: ./config/switch/enterprise/config_v20.cli

    pc_vlan10:
      kind: linux
      image: alpine_vntd:latest
      exec:
        - ip addr add 192.168.10.10/24 dev eth1
        - ip link set eth1 up
        - ip route del default
        - ip route add default via 192.168.10.1

    pc_vlan20:
      kind: linux
      image: alpine_vntd:latest
      exec:
        - ip addr add 192.168.20.10/24 dev eth1
        - ip link set eth1 up
        - ip route del default
        - ip route add default via 192.168.20.1

    pc_vlan30:
      kind: linux
      image: alpine_vntd:latest
      exec:
        - ip addr add 192.168.30.10/24 dev eth1
        - ip link set eth1 up
        - ip route del default
        - ip route add default via 192.168.30.1

    # Multilayer switch -> Juniper vJunos-switch
    # https://containerlab.dev/manual/kinds/vr-vjunosswitch/#lab-examples
    # https://containerlab.dev/lab-examples/srl-vjunos-switch/

    # Switch -> srlinux, molts mes exemples a seguir en la plana oficial de labs de containerlab
    # https://containerlab.dev/manual/kinds/srl/
    # https://containerlab.dev/lab-examples/srl-ceos/
    # https://learn.srlinux.dev/get-started/lab/

    # https://containerlab.dev/manual/kinds/ceos/#lab-examples

    # Firewall -> still searching
    # https://containerlab.dev/lab-examples/ftdv01/
    # https://github.com/srl-labs/containerlab/blob/main/lab-examples/ftdv01/ftdv01.yml
    # https://containerlab.dev/manual/kinds/vr-pan/
    # https://containerlab.dev/lab-examples/openbsd01/

    # Server -> to search

  links:  
    - endpoints: ["router_internet:eth4", "internet_server:eth1"]

    # Attacker network
    - endpoints: ["router_attacker:eth1", "router_internet:eth1"]
    - endpoints: ["attacker:eth1", "router_attacker:eth2"]

    # Benign network
    - endpoints: ["router_benign:eth1", "router_internet:eth2"]
    - endpoints: ["benign:eth1", "router_benign:eth2"]

    # Enterprise network
    - endpoints: ["router_enterprise:eth1", "router_internet:eth3"]
    #- endpoints: ["router_enterprise:eth2", "multilayer_switch:ge-0/0/0"]
    - endpoints: ["router_enterprise:eth2", "multilayer_switch:eth1"]

    # - endpoints: ["multilayer_switch:ge-0/0/1", "switch_vlan10:Ethernet1"]
    # - endpoints: ["multilayer_switch:ge-0/0/2", "switch_vlan20:Ethernet1"]
    #- endpoints: ["multilayer_switch:ge-0/0/3", "switch_vlan30:Ethernet1"]
    #- endpoints: ["multilayer_switch:ge-0/0/1", "switch_vlan10:e1-1"]

    - endpoints: ["multilayer_switch:eth2", "switch_vlan10:eth1"]
    - endpoints: ["multilayer_switch:eth3", "switch_vlan20:eth1"]
    - endpoints: ["multilayer_switch:eth4", "switch_vlan30:eth1"]

    - endpoints: ["switch_vlan10:eth2", "pc_vlan10:eth1"]
    - endpoints: ["switch_vlan20:eth2", "pc_vlan20:eth1"]
    - endpoints: ["switch_vlan30:eth2", "pc_vlan30:eth1"]