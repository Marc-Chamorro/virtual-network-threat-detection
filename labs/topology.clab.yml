# 0.0.2

# https://containerlab.dev/lab-examples/frr01/
# https://containerlab.dev/manual/config-mgmt/

# KALI - connect with bash, not cli

name: virtual-env

topology:
  nodes:

    ###############################################################################################
    # Internet
    ###############################################################################################
    
    router_internet:
      kind: linux
      image: frr_vntd:latest
      binds:
        - ./config/router/daemons:/etc/frr/daemons
        - ./config/router/internet/frr.conf:/etc/frr/frr.conf

    internet_server:
      kind: linux
      image: server_vntd:latest
      env: 
        WEB_SERVER: 1
        SSH_SERVER: 1
      exec:
        - ip addr add 172.16.100.100/24 dev eth1
        - ip link set eth1 up
        - ip route del default
        - ip route add default via 172.16.100.1

    ###############################################################################################
    # Attacker network
    ###############################################################################################
    
    router_attacker:
      kind: linux
      image: frr_vntd:latest
      binds:
        - ./config/router/daemons:/etc/frr/daemons
        - ./config/router/attacker/frr.conf:/etc/frr/frr.conf
    
    attacker:
      kind: linux
      image: kali_vntd:latest
      exec:
        - ip addr add 10.0.0.2/24 dev eth1
        - ip link set eth1 up
        - ip route del default
        - ip route add default via 10.0.0.1
    
    ###############################################################################################
    # Benign network
    ###############################################################################################
    
    router_benign:
      kind: linux
      image: frr_vntd:latest
      binds:
        - ./config/router/daemons:/etc/frr/daemons
        - ./config/router/benign/frr.conf:/etc/frr/frr.conf

    benign:
      kind: linux
      image: alpine_vntd:latest
      exec:
        - ip addr add 20.0.0.2/24 dev eth1
        - ip link set eth1 up
        - ip route del default
        - ip route add default via 20.0.0.1

    ###############################################################################################
    # Enterprise network
    ###############################################################################################
    
    # Network core
    #----------------------------------------------------------------------------------------------

    router_enterprise:
      kind: linux
      image: router_vntd:latest
      binds:
        - ./config/router/enterprise/startup.sh:/startup.sh
      exec:
        - sh /startup.sh

    # https://wiki.archlinux.org/title/Simple_stateful_firewall

    firewall:
      kind: linux
      image: firewall_vntd:latest
      binds:
        - ./config/firewall/enterprise/startup.sh:/startup.sh
      exec:
        - sh /startup.sh

    # Firewlll should go here
    #VyOS, pfSense, OPNSense, etc.
    # VyOS seems to be a good idea, to check later

    # Firewall -> still searching
    # https://containerlab.dev/lab-examples/ftdv01/
    # https://github.com/srl-labs/containerlab/blob/main/lab-examples/ftdv01/ftdv01.yml
    # https://containerlab.dev/manual/kinds/vr-pan/
    # https://containerlab.dev/lab-examples/openbsd01/


    # Multilayer switch -> Juniper vJunos-switch
    # https://containerlab.dev/manual/kinds/vr-vjunosswitch/#lab-examples
    # https://containerlab.dev/lab-examples/srl-vjunos-switch/

    # Switch -> srlinux, molts mes exemples a seguir en la plana oficial de labs de containerlab
    # https://containerlab.dev/manual/kinds/srl/
    # https://containerlab.dev/lab-examples/srl-ceos/
    # https://learn.srlinux.dev/get-started/lab/

    # https://containerlab.dev/manual/kinds/ceos/#lab-examples

    # Server -> to search

    # https://containerlab.dev/manual/nodes/#cpu-set
    # multilayer_switch:
      # kind: juniper_vjunosswitch
      # image: vrnetlab/juniper_vjunos-switch:23.2R1.14
      # startup-config: ./config/mls/enterprise/mls.cfg
      # cpu: 2
      # memory: 4GB

    # ┌──(root㉿attacker)-[/]
    # └─# curl 172.16.30.2
    # Hello from Nginx on the web server



    #multilayer_switch:
    #  kind: linux
    #  image: mls_vntd:latest
    #  binds:
    #    - ./config/mls/enterprise/startup.sh:/startup.sh
    #  exec:
    #    - sh /startup.sh

    # Does not support package filtering
    #multilayer_switch:
      #kind: arista_ceos
      #image: ceos_vntd:latest
      #startup-config: ./config/mls/enterprise/mls_arista.cli
      #startup-config: /home/marc/Documents/containerlab/virtual-network-threat-detection/labs/config/mls/enterprise/mls_arista.cli
      #exec:
      #  - bash -c "rm -f /mnt/flash/startup-config /mnt/flash/running-config"
    # Cli
    # enable
    # configure terminal

    # VLAN 10 - DMZ
    #----------------------------------------------------------------------------------------------
    switch_vlan10:
      kind: arista_ceos
      image: ceos_vntd:latest
      startup-config: ./config/switch/enterprise/config_v10.cli

    dmz_server:
      kind: linux
      image: server_vntd:latest
      env: 
        WEB_SERVER: 1
        SSH_SERVER: 1
      exec:
        - ip addr add 192.168.10.10/24 dev eth1
        - ip link set eth1 up
        - ip route del default
        - ip route add default via 192.168.10.1

    # VLAN 20 - Monitoring
    #----------------------------------------------------------------------------------------------
    switch_vlan20:
      kind: arista_ceos
      image: ceos_vntd:latest
      startup-config: ./config/switch/enterprise/config_v20.cli

    ids:
      kind: linux
      image: ids_vntd:latest
      exec:
        - ip addr add 192.168.20.10/24 dev eth1
        - ip link set eth1 up
        - ip route del default
        - ip route add default via 192.168.20.1
        - ip link set eth1 promisc on

    monitoring_server:
      kind: linux
      image: monitoring_vntd:latest
      exec:
        - ip addr add 192.168.20.11/24 dev eth1
        - ip link set eth1 up
        - ip route del default
        - ip route add default via 192.168.20.1

    # VLAN 30
    #----------------------------------------------------------------------------------------------
    switch_vlan30:
      kind: arista_ceos
      image: ceos_vntd:latest
      startup-config: ./config/switch/enterprise/config_v30.cli

    pc_vlan30:
      kind: linux
      image: alpine_vntd:latest
      exec:
        - ip addr add 192.168.30.10/24 dev eth1
        - ip link set eth1 up
        - ip route del default
        - ip route add default via 192.168.30.1

    # VLAN 40
    #----------------------------------------------------------------------------------------------
    switch_vlan40:
      kind: arista_ceos
      image: ceos_vntd:latest
      startup-config: ./config/switch/enterprise/config_v40.cli

    internal_server:
      kind: linux
      image: server_vntd:latest
      env: 
        # WEB_SERVER: 1
        SSH_SERVER: 1
      exec:
        - ip addr add 192.168.40.10/24 dev eth1
        - ip link set eth1 up
        - ip route del default
        - ip route add default via 192.168.40.1

    # VLAN 50
    #----------------------------------------------------------------------------------------------
    switch_floor1:
      kind: arista_ceos
      image: ceos_vntd:latest
      startup-config: ./config/switch/enterprise/config_v50.cli

    pc_vlan50_1:
      kind: linux
      image: alpine_vntd:latest
      exec:
        - ip addr add 192.168.50.10/24 dev eth1
        - ip link set eth1 up
        - ip route del default
        - ip route add default via 192.168.50.1

    pc_vlan60_1:
      kind: linux
      image: alpine_vntd:latest
      exec:
        - ip addr add 192.168.60.10/24 dev eth1
        - ip link set eth1 up
        - ip route del default
        - ip route add default via 192.168.60.1

    # VLAN 60
    #----------------------------------------------------------------------------------------------
    switch_floor2:
      kind: arista_ceos
      image: ceos_vntd:latest
      startup-config: ./config/switch/enterprise/config_v60.cli

    pc_vlan50_2:
      kind: linux
      image: alpine_vntd:latest
      exec:
        - ip addr add 192.168.50.11/24 dev eth1
        - ip link set eth1 up
        - ip route del default
        - ip route add default via 192.168.50.1

    pc_vlan60_2:
      kind: linux
      image: alpine_vntd:latest
      exec:
        - ip addr add 192.168.60.11/24 dev eth1
        - ip link set eth1 up
        - ip route del default
        - ip route add default via 192.168.60.1

  links:
    # Internet
    - endpoints: ["router_internet:eth4", "internet_server:eth1"]

    # Attacker network
    - endpoints: ["router_attacker:eth1", "router_internet:eth1"]
    - endpoints: ["attacker:eth1", "router_attacker:eth2"]

    # Benign network
    - endpoints: ["router_benign:eth1", "router_internet:eth2"]
    - endpoints: ["benign:eth1", "router_benign:eth2"]

    # Enterprise network
      # Network core
    - endpoints: ["router_internet:eth3", "router_enterprise:eth1"]
    - endpoints: ["router_enterprise:eth2", "firewall:eth1"]

      # VLAN 10
    - endpoints: ["firewall:eth2", "switch_vlan10:eth1"]
    - endpoints: ["switch_vlan10:eth2", "dmz_server:eth1"]

      # VLAN 20
    - endpoints: ["firewall:eth3", "switch_vlan20:eth1"]
    - endpoints: ["switch_vlan20:eth2", "ids:eth1"]
    - endpoints: ["switch_vlan20:eth3", "monitoring_server:eth1"]

      # VLAN 30
    - endpoints: ["firewall:eth4", "switch_vlan30:eth1"]
    - endpoints: ["switch_vlan30:eth2", "pc_vlan30:eth1"]

      # VLAN 40
    - endpoints: ["firewall:eth5", "switch_vlan40:eth1"]
    - endpoints: ["switch_vlan40:eth2", "internal_server:eth1"]

      # VLAN 50
    - endpoints: ["firewall:eth6", "switch_floor1:eth1"]
    - endpoints: ["switch_floor1:eth2", "pc_vlan50_1:eth1"]
    - endpoints: ["switch_floor1:eth3", "pc_vlan60_1:eth1"]

      # VLAN 60
    - endpoints: ["firewall:eth7", "switch_floor2:eth1"]
    - endpoints: ["switch_floor2:eth2", "pc_vlan50_2:eth1"]
    - endpoints: ["switch_floor2:eth3", "pc_vlan60_2:eth1"]