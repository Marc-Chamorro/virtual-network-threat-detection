name: virtual-env

topology:
  nodes:

    # =============================================================================================
    # Internet - Simulates the ISP and public internet backbone
    # =============================================================================================
    
    router_internet:
      kind: linux
      image: frr_vntd:latest
      binds:                                                    # Bind configuration files to make them persisten and editable
        - ./config/router/daemons:/etc/frr/daemons              
        - ./config/router/internet/frr.conf:/etc/frr/frr.conf

    internet_server:
      kind: linux
      image: server_vntd:latest
      env:                                                      # Environment variables to trigger specific service startups in entrypoint.sh
        WEB_SERVER: 1
        SSH_SERVER: 1
      exec:                                                     # Commands to be executed inside the container after startup
        - ip addr add 172.16.100.100/24 dev eth1                # Assign Public IP address
        - ip link set eth1 up                                   # Enable interface
        - ip route del default                                  # Remove Docker default gateway
        - ip route add default via 172.16.100.1                 # Point to Internet Router as default gateway

    # =============================================================================================
    # Attacker network - Simulates a hostile external actor
    # =============================================================================================
    
    router_attacker:
      kind: linux
      image: frr_vntd:latest
      binds:
        - ./config/router/daemons:/etc/frr/daemons
        - ./config/router/attacker/frr.conf:/etc/frr/frr.conf
    
    attacker:
      kind: linux
      image: kali_vntd:latest
      exec:
        - ip addr add 10.0.0.2/24 dev eth1
        - ip link set eth1 up
        - ip route del default
        - ip route add default via 10.0.0.1                     # Gateway is the attacker router
    
    # =============================================================================================
    # Benign network - Simulates normal external traffic
    # =============================================================================================
    
    router_benign:
      kind: linux
      image: frr_vntd:latest
      binds:
        - ./config/router/daemons:/etc/frr/daemons
        - ./config/router/benign/frr.conf:/etc/frr/frr.conf

    benign:
      kind: linux
      image: alpine_vntd:latest
      exec:
        - ip addr add 20.0.0.2/24 dev eth1
        - ip link set eth1 up
        - ip route del default
        - ip route add default via 20.0.0.1

    # =============================================================================================
    # Enterprise network - Main simulation target environment
    # =============================================================================================
    
    # Network core & security
    #----------------------------------------------------------------------------------------------
    router_enterprise:
      kind: linux
      image: router_vntd:latest
      binds:                                                    # Mounts the startup script to handle NAT and IP assignment
        - ./config/router/enterprise/startup.sh:/startup.sh
      exec:
        - sh /startup.sh

    firewall:
      kind: linux
      image: firewall_vntd:latest
      binds:                                                    # Mounts the complex iptables logic script
        - ./config/firewall/enterprise/startup.sh:/startup.sh
      exec:
        - sh /startup.sh

    # Additional network device
    #multilayer_switch:
    #  kind: linux
    #  image: mls_vntd:latest
    #  cpu: 2
    #  memory: 4GB
    #  binds:
    #    - ./config/mls/enterprise/startup.sh:/startup.sh
    #  exec:
    #    - sh /startup.sh

    # VLAN 10 - DMZ
    #----------------------------------------------------------------------------------------------
    switch_vlan10:
      kind: arista_ceos
      image: ceos_vntd:latest
      startup-config: ./config/switch/enterprise/config_v10.cli # Arista switches use startup-config file for persistent settings

    dmz_server:
      kind: linux
      image: server_vntd:latest
      env: 
        WEB_SERVER: 1
        SSH_SERVER: 1
      exec:
        - ip addr add 192.168.10.10/24 dev eth1
        - ip link set eth1 up
        - ip route del default
        - ip route add default via 192.168.10.1                 # Gateway is Firewall

    # VLAN 20 - Monitoring & IDS
    #----------------------------------------------------------------------------------------------
    switch_vlan20:
      kind: arista_ceos
      image: ceos_vntd:latest
      startup-config: ./config/switch/enterprise/config_v20.cli

    ids:
      kind: linux
      image: ids_vntd:latest
      exec:
        - ip addr add 192.168.20.10/24 dev eth1
        - ip link set eth1 up
        - ip route del default
        - ip route add default via 192.168.20.1
        - ip link set eth1 promisc on                           # Promiscuous mode to see traffic not addressed to it

    monitoring_server:
      kind: linux
      image: monitoring_vntd:latest
      exec:
        - ip addr add 192.168.20.11/24 dev eth1
        - ip link set eth1 up
        - ip route del default
        - ip route add default via 192.168.20.1

    # VLAN 30 - Administration
    #----------------------------------------------------------------------------------------------
    switch_vlan30:
      kind: arista_ceos
      image: ceos_vntd:latest
      startup-config: ./config/switch/enterprise/config_v30.cli

    pc_admin:
      kind: linux
      image: alpine_vntd:latest
      exec:
        - ip addr add 192.168.30.10/24 dev eth1
        - ip link set eth1 up
        - ip route del default
        - ip route add default via 192.168.30.1

    # VLAN 40 - Internal services
    #----------------------------------------------------------------------------------------------
    switch_vlan40:
      kind: arista_ceos
      image: ceos_vntd:latest
      startup-config: ./config/switch/enterprise/config_v40.cli

    internal_server:
      kind: linux
      image: server_vntd:latest
      env: 
        SSH_SERVER: 1
      exec:
        - ip addr add 192.168.40.10/24 dev eth1
        - ip link set eth1 up
        - ip route del default
        - ip route add default via 192.168.40.1

    # VLAN 50 - User floor 1
    #----------------------------------------------------------------------------------------------
    switch_floor1:                                              # This switchs handles trunking for multiple VLANs (50 & 60)
      kind: arista_ceos
      image: ceos_vntd:latest
      startup-config: ./config/switch/enterprise/config_v50.cli

    pc_vlan50_1:
      kind: linux
      image: alpine_vntd:latest
      exec:
        - ip addr add 192.168.50.10/24 dev eth1
        - ip link set eth1 up
        - ip route del default
        - ip route add default via 192.168.50.1

    pc_vlan60_1:
      kind: linux
      image: alpine_vntd:latest
      exec:
        - ip addr add 192.168.60.10/24 dev eth1
        - ip link set eth1 up
        - ip route del default
        - ip route add default via 192.168.60.1

    # VLAN 60 - User floor 2
    #----------------------------------------------------------------------------------------------
    switch_floor2:                                              # This switchs handles trunking for multiple VLANs (50 & 60)
      kind: arista_ceos
      image: ceos_vntd:latest
      startup-config: ./config/switch/enterprise/config_v60.cli

    pc_vlan50_2:
      kind: linux
      image: alpine_vntd:latest
      exec:
        - ip addr add 192.168.50.11/24 dev eth1
        - ip link set eth1 up
        - ip route del default
        - ip route add default via 192.168.50.1

    pc_vlan60_2:
      kind: linux
      image: alpine_vntd:latest
      exec:
        - ip addr add 192.168.60.11/24 dev eth1
        - ip link set eth1 up
        - ip route del default
        - ip route add default via 192.168.60.1

  # ===============================================================================================
  # Physical links between nodes
  # ===============================================================================================

  links:
    # Internet
    - endpoints: ["router_internet:eth4", "internet_server:eth1"]

    # Attacker network
    - endpoints: ["router_attacker:eth1", "router_internet:eth1"]
    - endpoints: ["attacker:eth1", "router_attacker:eth2"]

    # Benign network
    - endpoints: ["router_benign:eth1", "router_internet:eth2"]
    - endpoints: ["benign:eth1", "router_benign:eth2"]

    # Enterprise network
      # Network core
    - endpoints: ["router_internet:eth3", "router_enterprise:eth1"]
    - endpoints: ["router_enterprise:eth2", "firewall:eth1"]

      # VLAN 10
    - endpoints: ["firewall:eth2", "switch_vlan10:eth1"]
    - endpoints: ["switch_vlan10:eth2", "dmz_server:eth1"]

      # VLAN 20
    - endpoints: ["firewall:eth3", "switch_vlan20:eth1"]
    - endpoints: ["switch_vlan20:eth2", "ids:eth1"]
    - endpoints: ["switch_vlan20:eth3", "monitoring_server:eth1"]

      # VLAN 30
    - endpoints: ["firewall:eth4", "switch_vlan30:eth1"]
    - endpoints: ["switch_vlan30:eth2", "pc_admin:eth1"]

      # VLAN 40
    - endpoints: ["firewall:eth5", "switch_vlan40:eth1"]
    - endpoints: ["switch_vlan40:eth2", "internal_server:eth1"]

      # VLAN 50
    - endpoints: ["firewall:eth6", "switch_floor1:eth1"]
    - endpoints: ["switch_floor1:eth2", "pc_vlan50_1:eth1"]
    - endpoints: ["switch_floor1:eth3", "pc_vlan60_1:eth1"]

      # VLAN 60
    - endpoints: ["firewall:eth7", "switch_floor2:eth1"]
    - endpoints: ["switch_floor2:eth2", "pc_vlan50_2:eth1"]
    - endpoints: ["switch_floor2:eth3", "pc_vlan60_2:eth1"]
