# 0.0.1
name: virtual_env

topology:
  nodes:
  
    # Internet

    router_internet:
      kind: linux
      image: quay.io/frrouting/frr:10.5.0
      binds:
        - ./config/router/daemons:/etc/frr/daemons
        - ./config/router/frr.conf:/etc/frr/frr.conf
      exec:
        - ip addr add 172.16.10.1/30 dev eth1
        - ip addr add 172.16.20.1/30 dev eth2
        - ip link set eth1 up
        - ip link set eth2 up
        - sysctl -w net.ipv4.ip_forward=1
        - ip route del default

    # Attacker network

    attacker:
      kind: linux
      image: kali-custom:latest
      exec:
        - ip addr add 10.10.10.2/24 dev eth1
        - ip link set eth1 up
        - ip route del default                        # Remove all existing connections, including the internet
        - ip route add default via 10.10.10.1

    router_attacker:
      kind: linux
      image: quay.io/frrouting/frr:10.5.0             # https://github.com/FRRouting/frr/releases
      binds:
        - ./config/router/daemons:/etc/frr/daemons    # Which services to turn on
        - ./config/router/frr.conf:/etc/frr/frr.conf  # Router settings
      exec:
        - ip addr add 10.10.10.1/24 dev eth1
        - ip addr add 172.16.10.2/30 dev eth2
        - ip link set eth1 up
        - ip link set eth2 up
        - sysctl -w net.ipv4.ip_forward=1             # Enable ip forwarding - similar to https://openvpn.net/as-docs/faq-ip-forwarding-on-linux.html
        - ip route del default

    # Benign

    benign:
      kind: linux
      image: wbitt/network-multitool:alpine-extra
      exec:
        - ip addr add 10.20.20.10/24 dev eth1
        - ip link set eth1 up
        - ip route del default                        # Remove all existing connections, including the internet
        - ip route add default via 10.20.20.1

    router_benign:
      kind: linux
      image: quay.io/frrouting/frr:10.5.0
      exec:
        - ip addr add 172.16.20.2/30 dev eth1
        - ip addr add 10.20.20.1/24 dev eth2
        - ip link set eth1 up
        - ip link set eth2 up
        - sysctl -w net.ipv4.ip_forward=1
        - ip route del default

  links:
    - endpoints: ["attacker:eth1", "router_attacker:eth1"]
    - endpoints: ["router_attacker:eth2", "router_internet:eth1"]
    
    - endpoints: ["benign:eth1", "router_benign:eth2"]
    - endpoints: ["router_benign:eth1", "router_internet:eth2"]
